<html>

<head>

	<!-- Load ioBroker scripts and styles-->
	<link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css"/>
	<link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
	<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

	<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

	<script type="text/javascript" src="../../js/translate.js"></script>
	<script type="text/javascript" src="../../lib/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
	<script type="text/javascript" src="../../lib/js/selectID.js"></script>
	<script type="text/javascript" src="../../lib/js/materialize.js"></script>
	<script type="text/javascript" src="../../js/adapter-settings.js"></script>

	<!-- Load our own files -->
	<link rel="stylesheet" type="text/css" href="style.css" />
	<script type="text/javascript" src="words.js"></script>
	<!-- <script type="text/javascript" src="index_m.js"></script> -->
	<script>
		// This will be called by the admin adapter when the settings page loads
		function load(settings, onChange) {
			// example: select elements with id=key and class=value and insert value
			if (!settings) return;

			let debug = settings.debug;
			let GlobalSettings = settings.GlobalSettings;
			let LightGroups = settings.LightGroups;

			let createdGroups = {};
			globalThis.createdLights = {};
			globalThis.createdSensors = {};
			let indexGroups = 0;

			//Set Values of Global Settings
	
			$(".global").each(function () {

				const $key = $(this);
				const id = $key.attr("id");

				if(GlobalSettings) {
					if(!GlobalSettings.hasOwnProperty(id)) {
						GlobalSettings[id] = "";
					}
				} else {
					GlobalSettings = {};
					GlobalSettings[id] = "";
				}

				if ($key.attr("type") === "checkbox") {
					// do not call onChange direct, because onChange could expect some arguments
					$key.prop("checked", GlobalSettings[id] ? GlobalSettings[id] : false )
						.on("change", () => onChange())
					;
				} else {
					if(GlobalSettings[id]) {
						// do not call onChange direct, because onChange could expect some arguments
						$key.val(GlobalSettings[id] ? GlobalSettings[id] : "")
							.on("change", () => onChange())
							.on("keyup", () => onChange())
						;
					}
				}
			});


			//Create Groups and set values
			if(LightGroups) {

				Object.keys(LightGroups).forEach((Group, index) => {
					createdGroups[index] = Group;
					const newGroup = NewGroup(Group, LightGroups[Group], GlobalSettings, index);
					$( "#LightGroups" ).append( newGroup );
				
				});
				afterCare();
			}

			function afterCare() {
				translateAll("#LightGroups");
				loadOptions();
				$(".value, .global ")
					.on("change", () => onChange())
					.on("keyup", () => onChange())
				;
			}

			onChange(false);

			// reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
			if (M) M.updateTextFields();

			//++++++++++ TABS ++++++++++
			//Enhance Tabs with onShow-Function
			//$("ul.tabs li a").on("click", function () { onTabShow($(this).attr("href")); });
			$("ul.tabs li a").on("click", function () { 
				loadOptions(); 
			});
			
			function onTabShow(tabId) {
				switch (tabId) {
					case "#tab-settings":
						loadOptions();
						break;
					case "#tab-general":
						loadOptions();
						break;
				}
			}
			//++++++++++ OPTIONS ++++++++++
			//Load Options
			function loadOptions() {

				$(':checkbox').each(function() {
					setHideOrNot($(this), this);
				}); 

				$(".switchOnOff").change(function() {
					setHideOrNot($(this), this);
				});

				$("#debuglogging").change(function() {
					onChange();
				});

				if (M) M.updateTextFields();
				
				$(".collapsible").collapsible();
				$(".modal").modal();

				document.addEventListener('DOMContentLoaded', function() {
					var elems = document.querySelectorAll('select');
					var instances = M.FormSelect.init(elems, {
					// specify options here
					});
				});

				$("select").select();

				//+++++++++ BUTTONS +++++++++++

				//Add New Group
				$("#addNewGroup").on("click", function () {

					//Set new groupIndex
					const groupIndex = Object.keys(createdGroups).length;
					
					//Set InputField
					const $input = $("#newGroupName");
					
					//Open Modal
					$("#newGroupDialog").modal("open");
					$input.val("").focus();

					//Click Button in Modal
					$("#newGroupDialog_Btn").click(function(){ 

						//Get Value of Inputfield
						const newGroupName = $input.val();						

						//Check if Value contains no special characters or is duplicated
						if(containsSpecialChars(newGroupName) || Object.values(createdGroups).includes(newGroupName)){
							
							$input.addClass('invalid');

						} else {
							
							$input.addClass('valid');							
							
							//Create new Group
							const Group = {"LuxSensor": "", "lights": {}, "sensors": {}};
							const newGroup = NewGroup(newGroupName, Group, GlobalSettings, groupIndex);
							
							//Add Group to createdGroups
							createdGroups[groupIndex] = newGroupName;
							
							$( "#LightGroups" ).append( newGroup );
							$("#editGroupNameDialog").modal("close");
							onChange();
							afterCare();						

						}	
						
					}); 			

				});
				
				//Remove Group
				$(".removeGroup").on("click", function () {
					const groupIndex = $(this).closest( "li" ).data("groupindex")
					const $element = $(this).closest( "li" );
															
					$("#confirmRemove").modal("open"); 
					$("#confirmRemove_YesBtn").click(function(){ 
						$element.remove();
						$("#confirmRemove").modal("close");
						createdGroups[groupIndex] = null;
						onChange();
					});

				});

				//Remove Light
				$(".removeLight").on("click", function () {
					const groupIndex = $(this).closest( "li" ).data("groupindex");
					const lightIndex = $(this).closest( "li" ).data("lightindex");
					const $element = $(this).closest( "li" );
										
					$("#confirmRemove").modal("open"); 
					$("#confirmRemove_YesBtn").click(function(){ 
						$element.remove();
						$("#confirmRemove").modal("close");
						createdLights[groupIndex][lightIndex] = null;
						onChange();
					}); 			

				});

				//Edit GroupName
				$(".editGroupName").on("click", function () {
					const $input = $("#editGroupName");
					const groupIndex = $(this).closest( "li" ).data("groupindex");
										
					$("#editGroupNameDialog").modal("open");
					$input.data("groupindex", groupIndex).focus()
						
				});

				$("#editGroupNameDialog_Btn").click(function(){ 

					const $input = $("#editGroupName");
					const newGroupName = $input.val();
					const groupIndex = $input.data("groupindex");

					if(containsSpecialChars(newGroupName) || Object.values(createdGroups).indexOf(newGroupName) > -1){
						
						$input.addClass('invalid');

					} else {
						
						$input.addClass('valid');
						createdGroups[groupIndex] = newGroupName;

						$("li[data-groupindex='" + groupIndex + "'] [data-type='GroupName']").text(newGroupName);
						$("#editGroupNameDialog").modal("close");
						$input.removeClass('valid').val("");
						onChange();

					}
				});

				//Add New Light
				$(".addNewLight").on("click", function () {

					//Get groupIndex
					const groupIndex = $(this).closest( "li" ).data("groupindex");	

					//Set new lightIndex
					const lightIndex = Object.keys(createdLights[groupIndex]).length;

					//Set InputField
					const $input = $("#newLightName");

					//Open Modal
					$("#newLightDialog").modal("open");
					$input.val("").data("groupIndex", groupIndex).focus();

					//Click Button in Modal
					$("#newLightDialog_Btn").click(function(){ 

						//Get Value of Inputfield
						const newLightName = $input.val();		

						//Check if Value contains no special characters or is duplicated
						if(containsSpecialChars(newLightName) || Object.values(createdLights[groupIndex]).includes(newLightName)){
							
							$input.addClass('invalid');

						} else {
							
							$input.addClass('valid');							
							
							//Create new Group
							const Light = {
								"power": {
									"oid": "",
									"onVal": "",
									"offVal": ""
								},
								"bri": {
									"oid": "",
									"minVal": "",
									"maxVal": "",
									"defaultVal": ""
								},
								"ct": {
									"oid": "",
									"minVal": "",
									"maxVal": ""
								},
								"sat": {
									"oid": "",
									"minVal": "",
									"maxVal": ""
								},
								"modeswitch": {
									"oid": "",
									"whiteModeVal": false,
									"colorModeVal": true
								},
								"color": {
									"oid": "",
									"type": "",
									"default": ""
								}
							};

							const newLight = NewLight(Light, newLightName, lightIndex, groupIndex);
							
							//Add Group to createdGroups
							createdLights[groupIndex][lightIndex] = newLightName;
							
							$( "ul[data-groupindex='" + groupIndex + "'][data-type='lights']" ).append( newLight );
							$("#editLightNameDialog").modal("close");
							afterCare();
							onChange();	

						}	
						
					}); 	
				});

				//Edit LightName
				$(".editLightName").on("click", function () {
					const $input = $("#editLightName");
					const groupIndex = $(this).closest( "li" ).data("groupindex");
					const lightIndex = $(this).closest( "li" ).data("lightindex");
										
					$("#editLightNameDialog").modal("open");
					$input.data("groupindex", groupIndex).data("lightindex", lightIndex).focus();
				});

				$("#editLightNameDialog_Btn").click(function(){ 

					const $input = $("#editLightName");
					const newLightName = $input.val();
					const groupIndex = $input.data("groupindex");
					const lightIndex = $input.data("lightindex");

					if(containsSpecialChars(newLightName) || Object.values(createdLights[groupIndex]).indexOf(newLightName) > -1){
						
						$input.addClass('invalid');

					} else {

						$input.addClass('valid');
						
						createdLights[groupIndex][lightIndex] = newLightName

						$("li[data-groupindex='" + groupIndex + "'][data-lightindex='" + lightIndex + "'] [data-type='LightName']").text(newLightName);
						
						$("#editLightNameDialog").modal("close");
						$input.removeClass('valid').val("");
						onChange();

					}
				});
				
				//Add New Sensor
				$(".addNewSensor").on("click", function () {

					//Get groupIndex
					const groupIndex = $(this).closest( "li" ).data("groupindex");				

					//Set new sensorIndex
					const sensorIndex = Object.keys(createdSensors[groupIndex]).length;

					//Set InputField
					const $input = $("#newSensorName");

					//Open Modal
					$("#newSensorDialog").modal("open");
					$input.val("").data("groupIndex", groupIndex).focus();

					//Click Button in Modal
					$("#newSensorDialog_Btn").click(function(){ 

						//Get Value of Inputfield
						const newSensorName = $input.val();			

						//Check if Value contains no special characters or is duplicated
						if(containsSpecialChars(newSensorName) || Object.values(createdSensors[groupIndex]).includes(newSensorName)){
							
							$input.addClass('invalid');

						} else {
							
							$input.addClass('valid');							
							
							//Create new Sensor
							const Sensor = {
								"oid": "",
								"motionVal": "",
								"noMotionVal": ""
							};

							const newSensor = NewSensor(Sensor, newSensorName, sensorIndex, groupIndex);
							
							//Add Group to createdGroups
							createdSensors[groupIndex][sensorIndex] = newSensorName;
							
							$( "#sensors_" +  groupIndex + "" ).append( newSensor );
							$("#editSensorNameDialog").modal("close");

							//Add Object-ID
							//const $inputField = $("#Input_Sensor_" + sensorIndex + "_oid_" + groupIndex);

							afterCare();
							
							/*
							initSelectId(function (sid) {
								sid.selectId("show", $inputField.val(), function (newId) {
									if (newId) {
										$inputField.val(newId).trigger("change");
									}
								});
							});
							*/
							
							onChange();

						}	
						
					}); 	
				});

				//Remove Sensor
				$(".removeSensor").on("click", function () {
					const groupIndex = $(this).closest( "div" ).data("groupindex");
					const sensorIndex = $(this).closest( "div" ).data("sensorindex");
					const $element = $(this).closest( "div[data-type='sensor']");
										
					$("#confirmRemove").modal("open"); 
					$("#confirmRemove_YesBtn").click(function(){ 
						$element.remove();
						$("#confirmRemove").modal("close");
						createdSensors[groupIndex][sensorIndex] = null;
						onChange();
					}); 			

				});

				//+++++++++ SELECTS +++++++++++
				$(".SelectID").on("click", function () {
					const $input = $(this)[0].tagName !== "INPUT" ? $(this).closest("div.row").find("input[data-type='select']") : $(this);
													
					initSelectId(function (sid) {
						sid.selectId("show", $input.val(), function (newId) {
							if (newId) {
								$input.val(newId).focus().trigger("change");
							}
						});
					});
					
					
				});

				//+++++++ SWITCHES +++++++//
				function checkSwitch() {
					$(".switchOnOff").change(function() {
						setHideOrNot($(this), this);
				
					});
				}

			}
			
		}

		// This will be called by the admin adapter when the user presses the save button
		function save(callback) {

			const obj = {};

			//Get Global Settings
			obj.GlobalSettings = {};

			$(".global").each(function () {
				const $this = $(this);
				if ($this.attr("type") === "checkbox") {
					obj.GlobalSettings[$this.attr("id")] = $this.prop("checked");
				} else if ($this.attr("type") === "number") {
					obj.GlobalSettings[$this.attr("id")] = parseFloat($this.val());
				} else {
					obj.GlobalSettings[$this.attr("id")] = $this.val();
				}
			});

			//Get LightGroups
			obj.LightGroups = {};

			$("li[data-type='Group']").each(function () {
				const Group = $(this).find("h6[data-type='GroupName']").text();
				const groupindex = $(this).data("groupindex");
				obj.LightGroups[Group] = {};

				//LuxSensor
				obj.LightGroups[Group].LuxSensor = $(this).find(".LuxSensorGroup").val();

				//Get Lights
				obj.LightGroups[Group].lights = {};
				$("li[data-type='light']", this).each(function () {
					const LightName = $(this).find("h6[data-type='LightName']").text();
					const Light = obj.LightGroups[Group].lights[LightName] = {};

					//Parameter Power
					Light.power = {};
					Light.power.oid = $(".LightPowerOid", this).val();
					Light.power.onVal = $(".LightPowerOnVal", this).val();
					Light.power.offVal = $(".LightPowerOnVal", this).val();

					//Parameter Brightness
					Light.bri = {};
					if($("input[data-name='briOnOff']", this).prop('checked')) {
						Light.bri.oid = $(".LightBriOid", this).val().trim(); 
						Light.bri.minVal = $(".LightBriMinVal", this).val().trim();
						Light.bri.maxVal = $(".LightBriMaxVal", this).val().trim();
						Light.bri.defaultVal = $(".LightBriDefault", this).val().trim();
					} else {
						Light.bri.oid = "";
						Light.bri.minVal = null;
						Light.bri.maxVal = null;
						Light.bri.defaultVal = null;
					}
					
					//Parameter Color-Temperature
					Light.ct = {};
					if($("input[data-name='ctOnOff']", this).prop('checked')) {
						Light.ct.oid = $(".LightCtOid", this).val().trim(); 
						Light.ct.minVal = $(".LightCtMinVal", this).val().trim();
						Light.ct.maxVal = $(".LightCtMaxVal", this).val().trim();
					} else {
						Light.ct.oid = "";
						Light.ct.minVal = null;
						Light.ct.maxVal = null;
					}

					//Parameter Saturation
					Light.sat = {};
					if($("input[data-name='satOnOff']", this).prop('checked')) {
						Light.sat.oid = $(".LightSatOid", this).val().trim(); 
						Light.sat.minVal = $(".LightSatMinVal", this).val().trim();
						Light.sat.maxVal = $(".LightSatMaxVal", this).val().trim();
					} else {
						Light.sat.oid = "";
						Light.sat.minVal = null;
						Light.sat.maxVal = null;
					}

					//Parameter ModeSwitch
					Light.modeswitch = {};
					if($("input[data-name='modeswitchOnOff']", this).prop('checked')) {
						Light.modeswitch.oid = $(".LightModeSwitchOid", this).val().trim(); 
						Light.modeswitch.minVal = $(".LightModeswitchWhiteModeVal", this).val().trim();
						Light.modeswitch.maxVal = $(".LightModeswitchColorModeVal", this).val().trim();
					} else {
						Light.modeswitch.oid = "";
						Light.modeswitch.whiteModeVal = false;
						Light.modeswitch.colorModeVal = true;
					}

					//Parameter Color
					Light.color = {};
					if($("input[data-name='colorOnOff']", this).prop('checked')) {
						Light.color.oid = $(".LightColorOid", this).val().trim(); 
						Light.color.type = $(".LightColorType", this).val().trim();
						Light.color.default = $(".LightColorDefault", this).val().trim();
					} else {
						Light.color.oid = "";
						Light.color.type = "";
						Light.color.default = "";

					}					

				});

				//Get Sensors
				obj.LightGroups[Group].sensors = {};
				$("div[data-type='sensor']", this).each(function () {
					const SensorName = $(this).find("input.SensorName").val();
					const Sensor = obj.LightGroups[Group].sensors[SensorName] = {};

					Sensor.oid = $(".SensorOid", this).val();
					Sensor.motionVal = $(".SensorMotionVal", this).val();
					Sensor.noMotionVal = $(".SensorNoMotionVal", this).val();
				});
			});

			obj.debug = $("#debuglogging").prop("checked");

			console.log(obj);
			callback(obj);
		}

		//******* GROUP TEMPLATE *******/
		function NewGroup(Group, LightGroup, GlobalSettings, index) {
			return `
				<li data-groupindex="${index}" data-type="Group">
					<div class="collapsible-header">
						<i class="flip material-icons">expand_more</i><h6 data-type="GroupName" class="value" >${Group}</h6>
					</div>
					<div class="collapsible-body">
						<div class="row">
							<div class="col s6">
								<a href="#" class="waves-effect waves-light btn blue translate editGroupName" ><i class="material-icons left translate">edit</i>Edit Groupname</a>
							</div>
							<div class="col s6 right-align">
								<a class="waves-effect waves-light btn red translate removeGroup"><i class="material-icons left">delete</i>Remove Group</a>
							</div>
						</div>
						<div class="col s12" id="tab-area-group">
							<ul class="tabs blue lighten-4" width="4%">
								<li class="tab col s6 l4"><a href="#tab-lights_${index}" class="translate active tab-lights-Group">Lights</a></li>
								<li class="tab col s6 l4 tab-extra"><a href="#tab-sensors_${index}" class="translate tab-sensors-Group">Sensors</a></li>
								<li class="tab col s6 l4 tab-extra"><a href="#tab-general_${index}" class="translate tab-general-Group">General</a></li>
							</ul>
						</div>
						<div class="row" id="SingleGroupSettings">

							<!-- TAB Lights -->
							<div id="tab-lights_${index}" class="col s12 page">
								<div class="row">
									<div class="col s12">
										<!-- <h6 class="translate title" style="background-color:#174475;">Lights</h6> -->
									</div>
								</div>
								<div class="row">
									<div class="col s12" id="events">
										<div class="row">
											<div class="col s2 m1 l1 left">
												<a class="btn-floating waves-effect waves-light blue addNewLight"><i class="material-icons">add</i></a>
											</div>
										</div>
									</div>
								</div>
								<div>
									<ul class="collapsible" data-type="lights" data-groupindex="${index}">
										${addLights(LightGroup.lights, index)}
									</ul>
								</div>
							</div>
							<!-- TAB Lights END -->

							<!-- TAB Sensors -->
							<div id="tab-sensors_${index}" class="col s12 page">
								<div class="row">
									<div class="col s12">
										<!-- <h6 class="translate title" style="background-color:#174475;">Sensors</h6> -->
									</div>
								</div>
								<div class="row">
									<div class="col s12" id="events">
										<div class="row">
											<div class="col s2 m1 l1 left">
												<a class="btn-floating waves-effect waves-light blue addNewSensor"><i class="material-icons">add</i></a>
											</div>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="col s12" id="sensors_${index}" data-type="sensors">
										${addSensors(LightGroup.sensors, index)}
									</div>
								</div>
							</div>
							<!-- TAB Sensors END -->

							<!-- TAB General -->
							<div id="tab-general_${index}" class="col s12 page">
								<div class="row">
									<div class="col s12">
										<!-- <h6 class="translate title" style="background-color:#174475;">General</h6> -->
									</div>
								</div>
								<div class="row">
                                    ${addSelectIdInput(LightGroup.LuxSensor !== "" ? LightGroup.LuxSensor : GlobalSettings.GlobalLuxSensor , `LuxSensor_${index}`, "Object ID for Lux-Sensor", "LuxSensorGroup", "s6")}
								</div>
							</div>
							<!-- TAB General END -->

						</div>
					</div>
				</li>
			`;
		}

		function addLights(Lights, groupIndex) {
			
			let result = "";
			createdLights[groupIndex] = {};
			
			if (Object.keys(Lights).length !== 0) {

				Object.keys(Lights).forEach((name, index) => {
					const Light = Lights[name];
					
					result += NewLight(Light, name, index, groupIndex);
					
					createdLights[groupIndex][index] = name;
					
				});	
			}

			return result;
		}

		function NewLight(Light, name, lightIndex, groupIndex) {

			return `
				<li data-lightindex="${lightIndex}" data-groupindex="${groupIndex}" data-type="light">
					<div class="collapsible-header">
						<i class="material-icons">expand_more</i><h6 data-type="LightName" >${name}</h6>
					</div>
					<div class="collapsible-body">
						<div class="row">
							<div class="col s6">
								<a href="#" class="waves-effect waves-light btn blue translate editLightName"><i class="material-icons left translate">edit</i>Edit Lightname</a>
							</div>
							<div class="col s6 right-align">
								<a href="#" class="waves-effect waves-light btn red translate removeLight"><i class="material-icons left translate">delete</i>Remove Light</a>
							</div>
						</div>
						<div class="LightProperties">
							<div class="row" data-type="power">
								<div class="col s6 oid">${addSelectIdInput(Light.power.oid, `Light_${lightIndex}_power.oid_${groupIndex}`, "Object ID for Power On/Off", "LightPowerOid", "s10", "oid")}</div>
								<div class="col s3 onVal">${addInput(Light.power.onVal, `Light_${lightIndex}_power.onVal_${groupIndex}`, "Value for Power On", "LightPowerOnVal", "text", "onVal")}</div>
								<div class="col s3 offVal">${addInput(Light.power.offVal, `Light_${lightIndex}_power.offVal_${groupIndex}`, "Value for Power Off", "LightPowerOffVal", "text", "offVal")}</div>
							</div>
							<div class="row">
								<div class="col s12">
									<div class="switch">
										<span class="translate">Brightness Control</span>
										<label for="Light_${lightIndex}_bri_onOff_${groupIndex}">
											<input type="checkbox" id="Light_${lightIndex}_bri_onOff_${groupIndex}" data-name="briOnOff" class="switchOnOff" ${Light.bri.oid !== "" ? 'checked="checked"' : ''}  />
											<span class="lever"></span>
										</label>
									</div>
								</div>
							</div>
							<div class="row" data-type="bri">
								<div class="col s5 oid">${addSelectIdInput(Light.bri.oid, `Light_${lightIndex}_bri.oid_${groupIndex}`, "Object ID for Brightness", "LightBriOid", "s10", "oid")}</div>
								<div class="col s2 minVal">${addInput(Light.bri.minVal, `Light_${lightIndex}_bri.minVal_${groupIndex}`, "Value for minimum Brightness", "LightBriMinVal", "number", "minVal")}</div>
								<div class="col s2 maxVal">${addInput(Light.bri.maxVal, `Light_${lightIndex}_bri.maxVal_${groupIndex}`, "Value for maximum Brightness", "LightBriMaxVal", "number", "maxVal")}</div>
								<div class="col s2 defaultVal">${addInput(Light.bri.defaultVal !== "" ? Light.bri.defaultVal : 100, `Light_${lightIndex}_bri.defaultVal_${groupIndex}`, "Value/Offset for Brightness", "LightBriDefault", "number", "defaultVal")}</div>
							</div>
							<div class="row">
								<div class="col s12">
									<div class="switch">
										<span class="translate">Color-Temperature Control</label>
										<label for="Light_${lightIndex}_ct_onOff_${groupIndex}">
											<input type="checkbox" id="Light_${lightIndex}_ct_onOff_${groupIndex}" data-name="ctOnOff" class="switchOnOff" ${Light.ct.oid !== "" ? 'checked="checked"' : ''}/>
											<span class="lever"></span>
										</label>
									</div>
								</div>
							</div>
							<div class="row" data-type="ct">
								<div class="col s6 oid">${addSelectIdInput(Light.ct.oid, `Light_${lightIndex}_ct.oid_${groupIndex}`, "Object ID for Color-Temperature", "LightCtOid", "s10", "oid")}</div>
								<div class="col s3 minVal">${addInput(Light.ct.minVal, `Light_${lightIndex}_ct.minVal_${groupIndex}`, "Value for minimum Color-Temperature", "LightCtMinVal", "number", "minVal")}</div>
								<div class="col s3 maxVal">${addInput(Light.ct.maxVal, `Light_${lightIndex}_ct.maxVal_${groupIndex}`, "Value for maximum Color-Temperature", "LightCtMaxVal", "number", "maxVal")}</div>
							</div>
							<div class="row">
								<div class="col s12">
									<div class="switch">
										<span class="translate">Saturation Control</label>
										<label for="Light_${lightIndex}_sat_onOff_${groupIndex}">
											<input type="checkbox" id="Light_${lightIndex}_sat_onOff_${groupIndex}" data-name="satOnOff" class="switchOnOff" ${Light.sat.oid !== "" ? 'checked="checked"' : ''}/>
											<span class="lever"></span>
										</label>
									</div>
								</div>
							</div>
							<div class="row" data-type="sat">
								<div class="col s6 oid">${addSelectIdInput(Light.sat.oid, `Light_${lightIndex}_sat.oid_${groupIndex}`, "Object ID for Saturation", "LightSatOid", "s10", "oid")}</div>
								<div class="col s3 minVal">${addInput(Light.sat.minVal, `Light_${lightIndex}_sat.minVal_${groupIndex}`, "Value for minimum Saturation", "LightSatMinVal", "number", "minVal")}</div>
								<div class="col s3 maxVal">${addInput(Light.sat.maxVal, `Light_${lightIndex}_sat.maxVal_${groupIndex}`, "Value for maximum Saturation", "LightSatMaxVal", "number", "maxVal")}</div>
							</div>
							<div class="row">
								<div class="col s12">
									<div class="switch">
										<span class="translate">ModeSwitch Control</label>
										<label for="Light_${lightIndex}_modeswitch_onOff_${groupIndex}">
											<input type="checkbox" id="Light_${lightIndex}_modeswitch_onOff_${groupIndex}" data-name="modeswitchOnOff" class="switchOnOff" ${Light.modeswitch.oid !== "" ? 'checked="checked"' : ''}/>
											<span class="lever"></span>
										</label>
									</div>
								</div>
							</div>
							<div class="row" data-type="modeswitch">
								<div class="col s6 oid">${addSelectIdInput(Light.modeswitch.oid, `Light_${lightIndex}_modeswitch.oid_${groupIndex}`, "Object ID for Mode Switch", "LightModeswitchOid", "s10", "oid")}</div>
								<div class="col s3 whiteModeVal">${addInput(Light.modeswitch.whiteModeVal, `Light_${lightIndex}_modeswitch.whiteModeVal_${groupIndex}`, "Value for White Mode", "LightModeswitchWhiteModeVal", "text", "whiteModeVal")}</div>
								<div class="col s3 colorModeVal">${addInput(Light.modeswitch.colorModeVal, `Light_${lightIndex}_modeswitch.colorModeVal_${groupIndex}`, "Value for Color Mode", "LightModeswitchColorModeVal", "text", "colorModeVal")}</div>
							</div>
							<div class="row">
								<div class="col s12">
									<div class="switch">
										<span class="translate">Color Control</label>
										<label for="Light_${lightIndex}_color_onOff_${groupIndex}">
											<input type="checkbox" id="Light_${lightIndex}_color_onOff_${groupIndex}" data-name="colorOnOff" class="switchOnOff" ${Light.color.oid !== "" ? 'checked="checked"' : ''}/>
											<span class="lever"></span>
										</label>
									</div>
								</div>
							</div>
							<div class="row" data-type="color">
								<div class="col s6 oid">${addSelectIdInput(Light.color.oid, `Light_${lightIndex}_color.oid_${groupIndex}`, "Object ID for Color", "LightColorOid", "s10", "oid")}</div>
								<div class="col s3 type">
									<div class="input-field col s12 select">
										<select id="Light_${lightIndex}_color.type_${groupIndex}" data-name="colorType" class="LightColorType value">
											<option value="" ${(Light.color.type).toLowerCase() === "" ? "selected disabled" : ""}></option>
											<option value="HEX" ${(Light.color.type).toLowerCase() === "hex" ? "selected" : ""}>HEX</option>
											<option value="RGB" ${(Light.color.type).toLowerCase() === "rgb" ? "selected" : ""}>RGB</option>
											<option value="XY" ${(Light.color.type).toLowerCase() === "xy" ? "selected" : ""}>XY</option>
										</select>
										<label class="translate">Color-Type</label>
									</div>
								</div>
								<div class="col s3 default">${addInput(Light.color.default !== "" ? Light.color.default: "#FFFFFF", `Light_${lightIndex}_color.default_${groupIndex}`, "Default Value for Color", "LightColorDefault", "text", "colorDefault")}</div>
							</div>
						</div>
					</div>
				</li>
			`;
		}

		function addSensors(Sensors, groupIndex) {

			let result = "";
			createdSensors[groupIndex] = {};
			
			if (Object.keys(Sensors).length !== 0) {

				Object.keys(Sensors).forEach((name, index) => {
					const Sensor = Sensors[name];
					
					result += NewSensor(Sensor, name, index, groupIndex);
					
					createdSensors[groupIndex][index] = name;
					
				});
			}

			return result;
		}

		function NewSensor(Sensor, name, sensorIndex, groupIndex) {
			return `
				<div class="row" data-type="sensor" data-sensorindex="${sensorIndex}" data-groupindex="${groupIndex}" ">
					<div class="col s1">
                    	<a class="btn-floating waves-effect waves-light red removeSensor"><i class="material-icons">remove</i></a>
                	</div>
					<div class="col s2" data-type="sensorName">${addInput(name, `Sensor_${sensorIndex}_desc_${groupIndex}`, "Description", "SensorName", "text", "sensorName")}</div>
					<div class="col s5" data-type="oid">${addSelectIdInput(Sensor.oid, `Sensor_${sensorIndex}_oid_${groupIndex}`, "Object ID of Sensor", "SensorOid", "s10", "oid")}</div>
					<div class="col s2" data-type="motionVal">${addInput(Sensor.motionVal, `Sensor_${sensorIndex}_motionVal_${groupIndex}`, "Value for Motion", "SensorMotionVal", "text", "motionVal")}</div>
					<div class="col s2" data-type="noMotionVal">${addInput(Sensor.noMotionVal, `Sensor_${sensorIndex}_noMotionVal_${groupIndex}`, "Value for no Motion", "SensorNoMotionVal", "text", "noMotionVal")}</div>					
				</div>
			`;
		}

		/**
		 * Create a Input Field to select an Object-ID
		 * @param {string} value
		 * @param {string} id
		 * @param {string} label Label-Text
		 * @param {string} addClass Add more Classes with space limiter
		 * @param {string} size Size of the Input Field
		 */
		function addSelectIdInput(value, id, label, addClass, size, dataName) {
			return `
				<div class="col ${size} input-field">
                    <input type="text" class="validate value form-control ${addClass}" id="Input_${id}" value="${value}" data-name="${dataName}" data-type="select"/>
                     <label for="Input_${id}" class="translate">${label}</label>
                </div>
				<div class="col s1 m2 l1">
                    <a id="PopUp_${id}" class="btn-floating waves-effect waves-light blue table-button-add trigger-add SelectID"><i class="material-icons">add</i></a>
                </div>
			`;
		}

		/**
		 * Create a Input Field to select an Object-ID
		 * @param {string} value
		 * @param {string} id
		 * @param {string} label Label-Text
		 * @param {string} addClass Add more Classes with space limiter
		 * @param {string} size Size of the Input Field
		 */
		 function addSelectIdInputTable(value, id, label, addClass, size, dataName) {
			return `
				<div class="input-field">
                    <input type="text" class="validate form-control ${addClass}" id="Input_${id}" value="${value}" data-name="${dataName}" data-type="select"/>
                     <label for="Input_${id}" class="translate">${label}</label>
                </div>
				<div class="col s1 m2 l1">
                    <a id="PopUp_${id}" class="btn-floating waves-effect waves-light blue table-button-add trigger-add SelectID"><i class="material-icons">add</i></a>
                </div>
			`;
		}

		/**
		 * Create a Input Field for Values
		 * @param {string} value
		 * @param {string} id
		 * @param {string} label Label-Text
		 * @param {string} addClass Add more Classes with space limiter
		 * @param {string | number} 
		 */
		function addInput(value, id, label, addClass, type, dataName) {
			return `
				<div class="input-field">
                    <input type="${type}" class="validate form-control value ${addClass}" id="${id}" data-name="${dataName}" value="${value}" />
                     <label for="${id}" class="translate">${label}</label>
                </div>
			`;
		}

		//Set Hide or not if checkboxes are set
		function setHideOrNot($this, element) {
			const klasse = (element.id).split("_")[2];
			console.log(klasse);
			if(element.checked) {
				$this.closest(".LightProperties").find("[data-type="+ klasse +"]").removeClass("hide");
			} else {
				$this.closest(".LightProperties").find("[data-type="+ klasse +"]").addClass("hide");
			}	
		}

		//SELECT ID FUNCTION
		let selectId;
		function initSelectId(callback) {
			if (selectId) {
				return callback(selectId);
			}
			socket.emit("getObjects", function (err, objs) {
				selectId = $("#dialog-select-member").selectId("init", {
					noMultiselect: true,
					objects: objs,
					imgPath: "../../lib/css/fancytree/",
					filter: { type: "state" },
					name: "scenes-select-state",
					texts: {
						select: _("Select"),
						cancel: _("Cancel"),
						all: _("All"),
						id: _("ID"),
						name: _("Name"),
						role: _("Role"),
						room: _("Room"),
						value: _("Value"),
						selectid: _("Select ID"),
						from: _("From"),
						lc: _("Last changed"),
						ts: _("Time stamp"),
						wait: _("Processing..."),
						ack: _("Acknowledged"),
						selectAll: _("Select all"),
						unselectAll: _("Deselect all"),
						invertSelection: _("Invert selection")
					},
					columns: ["image", "name", "role", "room"]
				});
				callback(selectId);
			});
		}

		//+++++++++ HELPER ++++++++
		function getGroupIndexNameFromId(id) {
			id = id.split("_");
			return id[id.length - 1]
		}

		function splittGroupId(id) {
			id = id.split("_");
			return {element: id[0], type: id[1], groupIndex: id[2]};
		}

		function splittLightId(id) {
			id = id.split("_");
			return {element: id[0], lightIndex:[1], type: id[2], groupIndex: id[3]};
		}

		function containsSpecialChars(str) {
			const specialChars = /[`!@#§$%^&*()+\-=\[\]{};':"\\|,.<>\/?~]/;
			return specialChars.test(str);
		}

		const isEveryInputEmpty = () => {
			let inputs = document.querySelectorAll('.container input');
			
			for (const input of inputs)
				if (input.value !== '') return false;
			
			return true;
		}

		function isEmpty(obj) {
			return Object.keys(obj).length === 0;
		}

	</script>

</head>

<body>

	<div class="m adapter-container">

		<div id="header-area" class="row" >
            <div id="header-logo-title" class="col s6" >
                <img class="logo" src="lightcontrol.png" >
                <p>
                    <span class="translate h-title">LightControl</span><br />
                    <span class="translate h-sub-title">Controlling your Lights…</span>
                </p>
            </div>
        </div>

		<!-- Put your content here -->
		<div class="row">
            <div class="col s12" id="tab-area">
                <ul class="tabs blue lighten-4" width="4%">
                    <li class="tab col s6 l4"><a href="#tab-settings" class="translate active">Group Settings</a></li>
                    <li class="tab col s6 l4 tab-extra"><a href="#tab-general" class="translate">General Settings</a></li>
                </ul>
            </div>

			<div class="row" id="GroupSettings">
                <!-- group settings -->
                <div id="tab-settings" class="col s12 page">
                    <div class="row">
                        <div class="col s12">
                            <h6 class="translate title" style="background-color:#174475;">Groups</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12" id="events">
                            <div class="row">
                                <div class="col s2 m1 l1 left">
                                    <a id="addNewGroup" class="btn-floating waves-effect waves-light blue table-button-add"><i class="material-icons">add</i></a>
                                </div>
                            </div>
						</div>
					</div>
					<ul class="collapsible popout" id="LightGroups"></ul>
				</div>
				<!-- general settings -->
				<div id="tab-general" class="col s12 page">
                    <div class="row">
                        <div class="col s12">
                            <h6 class="translate title" style="background-color:#174475;">General Settings</h6>
                        </div>
                    </div>
					<ul class="collapsible">
						<!-- Settings for Global Lux Sensor-->
						<li>
							<div class="collapsible-header">
								<i class="flip material-icons">expand_more</i><h6 class="translate">Settings for global Lux-Sensor</h6>
							</div>
							<div class="collapsible-body">
								<div class="row">
                                    <div class="col s8 l6 input-field">
                                        <input type="text" class="validate form-control global" id="GlobalLuxSensor" data-type="select" />
                                        <label for="GlobalLuxSensor" class="translate">Object ID for global Lux-Sensor</label>
                                        <!-- <span class="translate">Object ID for global Lux-Sensor</span> -->
                                    </div>
                                    <div class="col s1 m2 l1">
                                        <a id="GlobalLuxSensorPopUp" class="btn-floating waves-effect waves-light blue table-button-add trigger-add SelectID"><i class="material-icons">add</i></a>
                                    </div>
								</div>
							</div>
						</li>
						<!-- Settings for Color Temperature -->
						<li>
							<div class="collapsible-header">
								<i class="flip material-icons">expand_more</i><h6 class="translate">Settings for Color-Temperature</h6>
							</div>
							<div class="collapsible-body">
								<div class="row">
                                    <div class="col s6 l3 input-field">
                                        <input type="number" class="validate form-control global" id="minCt" value="2700" min="2700" max="6500"/>
                                        <label for="minCt" class="translate">Minimum Value for Color-Temperature (Kelvin)</label>
                                        <!-- <span class="translate">Minimum Value for Color-Temperature (Kelvin)</span> -->
                                    </div>
									<div class="col s6 l3 input-field">
                                        <input type="number" class="validate form-control global" id="maxCt" value="6500" min="2700" max="6500"/>
                                        <label for="maxCt" class="translate">Maximum Value for Color-Temperature (Kelvin)</label>
                                        <!-- <span class="translate">Maximum Value for Color-Temperature (Kelvin)</span> -->
                                    </div>
								</div>
							</div>
						</li>
						<!-- Settings for Brightness and Dimming -->
						<li>
							<div class="collapsible-header">
								<i class="flip material-icons">expand_more</i><h6 class="translate">Settings for Dimming</h6>
							</div>
							<div class="collapsible-body">
								<div class="row">
									<div class="col s6 l2 input-field">
										<input type="number" class="validate form-control global" id="RampSteps" value="10" min="5" max="30"/>
										<label for="RampSteps" class="translate">Ramp Steps for Dimming</label>
										<!-- <span class="translate">Ramp Steps for Dimming</span> -->
									</div>
									<div class="col s6 l2 input-field">
										<input type="number" class="valid form-control global" id="minBri" value="10" min="2" max="50" />
										<label for="minBri" class="translate">Minimum Brightness for Dimming</label>
										<!-- <span class="translate">Minimum Brightness for Dimming</span> -->
									</div>
								</div>
							</div>
						</li>
						<!-- Settings for Presence -->
						<li>
							<div class="collapsible-header">
								<i class="flip material-icons">expand_more</i><h6 class="translate">Settings for Presence</h6>
							</div>
							<div class="collapsible-body">
								<div class="row">
                                    <div class="col s8 l6 input-field">
                                        <input type="text" class="validate form-control global" id="IsPresenceDp" data-type="select" />
                                        <label for="IsPresenceDp" class="translate">Object ID for Presence</label>
                                        <!-- <span class="translate">Object ID for Presence</span> -->
                                    </div>
                                    <div class="col s1 m2 l1">
                                        <a id="IsPresenceDpPopUp" class="btn-floating waves-effect waves-light blue table-button-add trigger-add SelectID"><i class="material-icons">add</i></a>
                                    </div>
								</div>
								<div class="row">
                                    <div class="col s8 l6 input-field">
                                        <input type="text" class="validate form-control global" id="PresenceCountDp" data-type="select" />
                                        <label for="PresenceCountDp" class="translate">Object ID for Presence Counter</label>
                                        <!-- <span class="translate">Object ID for Presence Counter</span> -->
                                    </div>
                                    <div class="col s1 m2 l1">
                                        <a id="PresenceCountDpPopUp" class="btn-floating waves-effect waves-light blue table-button-add trigger-add SelectID"><i class="material-icons">add</i></a>
                                    </div>
								</div>
							</div>
						</li>
					</ul>
					<div class="row">
						<div class="col s12">
							<div class="switch">
								<span class="translate">Debug logging</span>
								<label for="debuglogging">
									<input type="checkbox" id="debuglogging" />
									<span class="lever"></span>
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- DIALOGS -->
		<div class="m material-dialogs">
			<!-- ID Select -->
            <div id="dialog-select-member" class="modal modal-fixed-footer">
                <div class="modal-content">
                    <div class="row">
                        <div class="col s12 title"></div>
                    </div>
                    <div class="row">
                        <div class="col s12 dialog-content">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="modal-action modal-close waves-effect waves-green btn btn-set"><i class="large material-icons left">check</i><span class="translate">Select</span></a>
                    <a class="modal-action modal-close waves-effect waves-green btn btn-close"><i class="large material-icons left ">close</i><span class="translate">Cancel</span></a>
                </div>
            </div>
			<!-- Confirm Dialog-->
			<div id="confirmRemove" class="modal">
				<div class="modal-content">
					<p class="translate">Are you sure to remove this?</p>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green green btn translate" onclick="$('#confirmRemove').modal('close'); return false;">No</a>
					<a href="#" class="waves-effect waves-red btn red translate" id="confirmRemove_YesBtn"><i class="material-icons left translate">delete</i>Yes</a>
			   </div>
			</div>
			<!-- New Group Dialog-->
			<div id="newGroupDialog" class="modal">
				<div class="modal-content">
					<p class="translate">Please set a name for the new LightGroup:</p>
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" class="validate form-control" id="newGroupName" />
							<label for="newGroupName" class="translate">Name</label>
							<span class="helper-text" data-error="Name already exists or not allowed" data-success="ok">No special characters allowed. Only "_" (underline)</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green red btn translate" onclick="$('#newGroupDialog').modal('close'); return false;">Cancel</a>
					<a href="#" class="waves-effect waves-red btn green translate" id="newGroupDialog_Btn"><i class="material-icons left translate">add_circle</i>Create</a>
				</div>
			</div>
			<!-- Change GroupName Dialog-->
			<div id="editGroupNameDialog" class="modal">
				<div class="modal-content">
					<p class="translate">Please set a new name for the LightGroup:</p>
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" class="form-control" id="editGroupName" />
							<label for="editGroupName" class="translate">Name</label>
							<span class="helper-text" data-error="Name already exists or not allowed" data-success="ok">No special characters allowed. Only "_" (underline)</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green red btn translate" onclick="$('#editGroupNameDialog').modal('close'); $('#editGroupName').removeClass('invalid'); return false;">Cancel</a>
					<a href="#" class="waves-effect waves-red btn green translate" id="editGroupNameDialog_Btn"><i class="material-icons left translate">edit</i>Edit</a>
				</div>
			</div>
			<!-- New Light Dialog-->
			<div id="newLightDialog" class="modal">
				<div class="modal-content">
					<p class="translate">Please set a name for the new Light:</p>
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" class="validate form-control" id="newLightName" />
							<label for="newLightName" class="translate">Name</label>
							<span class="helper-text" data-error="Name already exists or not allowed" data-success="ok">No special characters allowed. Only "_" (underline)</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green red btn translate" onclick="$('#newLightDialog').modal('close'); return false;">Cancel</a>
					<a href="#" class="waves-effect waves-red btn green translate" id="newLightDialog_Btn"><i class="material-icons left translate">add_circle</i>Create</a>
				</div>
			</div>
			<!-- Change LightName Dialog-->
			<div id="editLightNameDialog" class="modal">
				<div class="modal-content">
					<p class="translate">Please set a new name for the Light:</p>
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" class="validate form-control" id="editLightName" />
							<label for="editLightName" class="translate">Name</label>
							<span class="helper-text" data-error="Name already exists or not allowed" data-success="ok">No special characters allowed. Only "_" (underline)</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green red btn translate" onclick="$('#editLightNameDialog').modal('close'); $('#editLightName').removeClass('invalid'); return false;">Cancel</a>
					<a href="#" class="waves-effect waves-red btn green translate" id="editLightNameDialog_Btn"><i class="material-icons left translate">edit</i>Edit</a>
				</div>
			</div>
			<!-- New Sensor Dialog-->
			<div id="newSensorDialog" class="modal">
				<div class="modal-content">
					<p class="translate">Please set a name for the new Sensor:</p>
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" class="validate form-control" id="newSensorName" />
							<label for="newSensorName" class="translate">Name</label>
							<span class="helper-text" data-error="Name already exists or not allowed" data-success="ok">No special characters allowed. Only "_" (underline)</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green red btn translate" onclick="$('#newSensorDialog').modal('close'); return false;">Cancel</a>
					<a href="#" class="waves-effect waves-red btn green translate" id="newSensorDialog_Btn"><i class="material-icons left translate">add_circle</i>Create</a>
				</div>
			</div>
			<!-- Change SensorName Dialog-->
			<div id="editSensorNameDialog" class="modal">
				<div class="modal-content">
					<p class="translate">Please set a new name for the Sensor:</p>
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" class="validate form-control" id="editSensorName" />
							<label for="editSensorName" class="translate">Name</label>
							<span class="helper-text" data-error="Name already exists or not allowed" data-success="ok">No special characters allowed. Only "_" (underline)</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a href="#" class="waves-effect waves-green red btn translate" onclick="$('#editSensorNameDialog').modal('close'); $('#editSensorName').removeClass('invalid'); return false;">Cancel</a>
					<a href="#" class="waves-effect waves-red btn green translate" id="editSensorNameDialog_Btn"><i class="material-icons left translate">edit</i>Edit</a>
				</div>
			</div>
		</div>
	</div>

</body>

</html>